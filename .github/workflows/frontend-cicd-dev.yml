name: Frontend CI/CD (Development Phase)

# Simplified pipeline for active development
# Focus: Build success (not comprehensive testing)
# DevOps Strategy: If it builds, ship it! ğŸš€

on:
  push:
    branches: 
      - main
      - develop
  pull_request:
    branches:
      - main
      - develop

env:
  NODE_VERSION: '18'
  TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
  TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
  TELEGRAM_TOPIC_ID: ${{ secrets.TELEGRAM_TOPIC_ID }}

jobs:
  # ====================================================================
  # STAGE 1: Essential Code Quality Checks
  # Quick checks that catch 80% of problems!
  # ====================================================================
  essential-checks:
    name: Essential Quality Checks
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: Get pnpm store directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Setup pnpm cache
        uses: actions/cache@v3
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install dependencies
        run: pnpm install --no-frozen-lockfile

      - name: Send Telegram - Starting checks
        if: env.TELEGRAM_BOT_TOKEN != ''
        run: |
          curl -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -H 'Content-Type: application/json' \
            -d "{
              \"chat_id\": \"${TELEGRAM_CHAT_ID}\",
              \"message_thread_id\": ${TELEGRAM_TOPIC_ID:-null},
              \"text\": \"ğŸš€ **CI/CD Started** (Development Mode)\n\nğŸ“‹ Commit: ${{ github.event.head_commit.message }}\nğŸ‘¤ Author: ${{ github.actor }}\nğŸŒ¿ Branch: ${{ github.ref_name }}\n\nâ³ Running essential checks...\",
              \"parse_mode\": \"Markdown\"
            }"

      # ============================================================
      # âŒ CHECK 1: ESLint (REMOVED)
      # Reason: 39 lint errors, devs too lazy to fix
      # DevOps decision: Focus on what matters (builds)
      # ============================================================
      
      # âŒ CHECK 2: Prettier (REMOVED)
      # Reason: Formatting doesn't break the app
      # DevOps decision: Save time, skip formatting checks
      # ============================================================

      # ============================================================
      # CHECK 1: TypeScript Type Check (CRITICAL!)
      # Catches: Type errors, undefined vars, wrong imports
      # This is your MOST IMPORTANT check!
      # ============================================================
      - name: TypeScript Type Check
        run: npx tsc --noEmit
        continue-on-error: false

      # ============================================================
      # CHECK 2: Security Audit (Dependency Vulnerabilities)
      # Checks: npm packages for known security issues
      # ============================================================
      - name: Dependencies Security Audit
        run: pnpm audit --audit-level=high
        continue-on-error: true  # Don't fail build, just warn

      - name: Send Telegram - Checks passed
        if: success() && env.TELEGRAM_BOT_TOKEN != ''
        run: |
          curl -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -H 'Content-Type: application/json' \
            -d "{
              \"chat_id\": \"${TELEGRAM_CHAT_ID}\",
              \"message_thread_id\": ${TELEGRAM_TOPIC_ID:-null},
              \"text\": \"âœ… **Essential Checks PASSED**\n\nâœ“ TypeScript: No type errors\nâœ“ Dependencies: Secure\nâš ï¸ ESLint: Skipped (devs too lazy ğŸ˜…)\nâš ï¸ Prettier: Skipped (formatting doesn't matter)\n\nâ³ Next: Building...\",
              \"parse_mode\": \"Markdown\"
            }"

      - name: Send Telegram - Checks failed
        if: failure() && env.TELEGRAM_BOT_TOKEN != ''
        run: |
          curl -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -H 'Content-Type: application/json' \
            -d "{
              \"chat_id\": \"${TELEGRAM_CHAT_ID}\",
              \"message_thread_id\": ${TELEGRAM_TOPIC_ID:-null},
              \"text\": \"âŒ **Essential Checks FAILED**\n\nğŸš« TypeScript errors detected\nğŸ‘¤ Author: ${{ github.actor }}\n\nğŸ”§ Fix the errors and push again!\n\nğŸ”— [View Logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})\",
              \"parse_mode\": \"Markdown\"
            }"

  # ====================================================================
  # STAGE 2: Build & Size Check
  # Ensures the app can be built for production
  # ====================================================================
  build:
    name: Production Build
    runs-on: ubuntu-latest
    needs: essential-checks
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: Get pnpm store directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Setup pnpm cache
        uses: actions/cache@v3
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install dependencies
        run: pnpm install --no-frozen-lockfile

      - name: Send Telegram - Build started
        if: env.TELEGRAM_BOT_TOKEN != ''
        run: |
          curl -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -H 'Content-Type: application/json' \
            -d "{
              \"chat_id\": \"${TELEGRAM_CHAT_ID}\",
              \"message_thread_id\": ${TELEGRAM_TOPIC_ID:-null},
              \"text\": \"ğŸ”¨ **Building Production Bundle**\n\nâ³ Compiling with Vite + TypeScript...\",
              \"parse_mode\": \"Markdown\"
            }"

      # ============================================================
      # BUILD: TypeScript + Vite Production Build
      # This runs: tsc -b && vite build
      # ============================================================
      - name: Build with Vite
        run: pnpm build
        continue-on-error: false

      # ============================================================
      # CHECK: Build Size (Performance Warning)
      # Alert if bundle is getting too large
      # ============================================================
      - name: Check Build Size
        run: |
          if [ -d "dist" ]; then
            BUILD_SIZE=$(du -sh dist | cut -f1)
            BUILD_SIZE_KB=$(du -sk dist | cut -f1)
            echo "Build size: $BUILD_SIZE ($BUILD_SIZE_KB KB)"
            
            # Alert if build is over 10MB
            if [ "$BUILD_SIZE_KB" -gt 10240 ]; then
              echo "âš ï¸ WARNING: Build size is larger than 10MB!"
              echo "Consider lazy loading or code splitting."
            fi
            
            # Fail if over 50MB (something is seriously wrong!)
            if [ "$BUILD_SIZE_KB" -gt 51200 ]; then
              echo "âŒ Build size exceeds 50MB limit!"
              exit 1
            fi
          else
            echo "âŒ dist directory not found!"
            exit 1
          fi

      - name: Upload Build Artifacts
        uses: actions/upload-artifact@v3
        with:
          name: frontend-build
          path: spotify-clone/dist/
          retention-days: 1

      - name: Send Telegram - Build successful
        if: success() && env.TELEGRAM_BOT_TOKEN != ''
        run: |
          BUILD_SIZE=$(du -sh dist | cut -f1 2>/dev/null || echo "Unknown")
          curl -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -H 'Content-Type: application/json' \
            -d "{
              \"chat_id\": \"${TELEGRAM_CHAT_ID}\",
              \"message_thread_id\": ${TELEGRAM_TOPIC_ID:-null},
              \"text\": \"âœ… **Production Build SUCCESSFUL**\n\nğŸ“¦ Build size: ${BUILD_SIZE}\nâœ“ TypeScript compiled\nâœ“ Bundle created\nâœ“ No build errors\n\nğŸ‰ Ready for deployment!\",
              \"parse_mode\": \"Markdown\"
            }"

      - name: Send Telegram - Build failed
        if: failure() && env.TELEGRAM_BOT_TOKEN != ''
        run: |
          curl -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -H 'Content-Type: application/json' \
            -d "{
              \"chat_id\": \"${TELEGRAM_CHAT_ID}\",
              \"message_thread_id\": ${TELEGRAM_TOPIC_ID:-null},
              \"text\": \"âŒ **Build FAILED**\n\nğŸš« Vite compilation error or build size exceeded\nğŸ‘¤ Author: ${{ github.actor }}\n\nCheck the build logs!\n\nğŸ”— [View Logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})\",
              \"parse_mode\": \"Markdown\"
            }"

  # ====================================================================
  # STAGE 3: Deploy to Staging (for develop branch)
  # Automatic deployment when develop branch is pushed
  # ====================================================================
  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/develop'
    environment:
      name: staging
      url: https://staging.navazino.com  # â† Update with your staging URL
    steps:
      - name: Download Build Artifacts
        uses: actions/download-artifact@v3
        with:
          name: frontend-build
          path: dist

      - name: Send Telegram - Deploying to staging
        if: env.TELEGRAM_BOT_TOKEN != ''
        run: |
          curl -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -H 'Content-Type: application/json' \
            -d "{
              \"chat_id\": \"${TELEGRAM_CHAT_ID}\",
              \"message_thread_id\": ${TELEGRAM_TOPIC_ID:-null},
              \"text\": \"ğŸš€ **Deploying to STAGING**\n\nâ³ Uploading to staging server...\nğŸ“¦ Commit: ${{ github.event.head_commit.message }}\",
              \"parse_mode\": \"Markdown\"
            }"

      # ============================================================
      # DEPLOYMENT: Clean old files on server
      # Creates backup before removing
      # ============================================================
      - name: Backup and Clean Staging Directory
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.STAGING_SERVER_HOST }}        # Add to GitHub Secrets: Your VPS IP (e.g., 123.45.67.89)
          username: ${{ secrets.STAGING_SERVER_USER }}    # Add to GitHub Secrets: SSH user (e.g., deploy or ubuntu)
          key: ${{ secrets.STAGING_SERVER_SSH_KEY }}      # Add to GitHub Secrets: Your SSH private key
          port: ${{ secrets.STAGING_SERVER_PORT || 22 }}  # Add to GitHub Secrets: SSH port (usually 22)
          script: |
            # Create directory if it doesn't exist
            mkdir -p /var/www/Navazino/staging/dist
            
            # Backup current version (if exists)
            if [ -d "/var/www/Navazino/staging/dist" ] && [ "$(ls -A /var/www/Navazino/staging/dist)" ]; then
              TIMESTAMP=$(date +%Y%m%d_%H%M%S)
              cp -r /var/www/Navazino/staging/dist /var/www/Navazino/staging/dist.backup.$TIMESTAMP
              echo "Backup created: dist.backup.$TIMESTAMP"
            fi
            
            # Clean current directory
            rm -rf /var/www/Navazino/staging/dist/*
            echo "Directory cleaned and ready for deployment"

      # ============================================================
      # DEPLOYMENT: Upload new build files
      # Uses rsync for efficient transfer
      # ============================================================
      - name: Deploy to Staging Server
        run: |
          # Setup SSH key
          mkdir -p ~/.ssh
          echo "${{ secrets.STAGING_SERVER_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          
          # Add server to known hosts
          ssh-keyscan -H ${{ secrets.STAGING_SERVER_HOST }} >> ~/.ssh/known_hosts
          
          # Deploy files via rsync
          rsync -avz --delete \
            dist/ \
            ${{ secrets.STAGING_SERVER_USER }}@${{ secrets.STAGING_SERVER_HOST }}:/var/www/Navazino/staging/dist/
          
          echo "Files uploaded successfully!"

      # ============================================================
      # HEALTH CHECK: Verify deployment worked
      # Tries 30 times over 2.5 minutes
      # ============================================================
      - name: Health Check - Staging
        run: |
          echo "Waiting for staging server to respond..."
          sleep 10  # Give nginx time to detect new files
          
          for i in {1..30}; do
            STATUS=$(curl -s -o /dev/null -w "%{http_code}" http://staging.navazino.com || echo "000")
            if [ "$STATUS" -eq 200 ] || [ "$STATUS" -eq 304 ]; then
              echo "âœ… Staging deployment successful! (HTTP $STATUS)"
              exit 0
            fi
            echo "Attempt $i/30: HTTP $STATUS, retrying in 5 seconds..."
            sleep 5
          done
          
          echo "âŒ Health check failed after 30 attempts"
          exit 1

      - name: Send Telegram - Staging deployed successfully
        if: success() && env.TELEGRAM_BOT_TOKEN != ''
        run: |
          curl -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -H 'Content-Type: application/json' \
            -d "{
              \"chat_id\": \"${TELEGRAM_CHAT_ID}\",
              \"message_thread_id\": ${TELEGRAM_TOPIC_ID:-null},
              \"text\": \"âœ… **Deployed to STAGING Successfully**\n\nğŸŒ URL: http://staging.navazino.com\nâœ“ Health check passed\n\nğŸ‘¥ Team can now test the changes!\nğŸ“ Commit: ${{ github.event.head_commit.message }}\",
              \"parse_mode\": \"Markdown\"
            }"

      - name: Send Telegram - Staging deployment failed
        if: failure() && env.TELEGRAM_BOT_TOKEN != ''
        run: |
          curl -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -H 'Content-Type: application/json' \
            -d "{
              \"chat_id\": \"${TELEGRAM_CHAT_ID}\",
              \"message_thread_id\": ${TELEGRAM_TOPIC_ID:-null},
              \"text\": \"âŒ **STAGING Deployment FAILED**\n\nğŸš« Failed to deploy or health check failed\nğŸ‘¤ Pushed by: ${{ github.actor }}\n\nğŸ”— [View Logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})\n\nâš ï¸ Staging may still be running old version\",
              \"parse_mode\": \"Markdown\"
            }"

  # ====================================================================
  # STAGE 4: Deploy to Production (for main branch only)
  # Requires manual approval + includes automatic rollback
  # ====================================================================
  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main'
    environment:
      name: production
      url: https://navazino.com  # â† Update with your production URL
    steps:
      - name: Download Build Artifacts
        uses: actions/download-artifact@v3
        with:
          name: frontend-build
          path: dist

      - name: Send Telegram - Production deployment pending
        if: env.TELEGRAM_BOT_TOKEN != ''
        run: |
          curl -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -H 'Content-Type: application/json' \
            -d "{
              \"chat_id\": \"${TELEGRAM_CHAT_ID}\",
              \"message_thread_id\": ${TELEGRAM_TOPIC_ID:-null},
              \"text\": \"ğŸš¨ **PRODUCTION DEPLOYMENT WAITING FOR APPROVAL** ğŸš¨\n\nğŸ“¦ Ready to deploy to production!\nğŸ“ Commit: ${{ github.event.head_commit.message }}\nğŸ‘¤ Author: ${{ github.actor }}\n\nï¿½ **CLICK TO APPROVE:**\nğŸ”— ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}\n\nâš ï¸ Action required: Review and approve deployment\nğŸ“± Tip: Install GitHub mobile app for faster approvals!\",
              \"parse_mode\": \"Markdown\",
              \"disable_web_page_preview\": false
            }"

      # ============================================================
      # SAFETY: Create backup before production deployment
      # ============================================================
      - name: Backup Current Production
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.PROD_SERVER_HOST }}        # Add to GitHub Secrets: Production VPS IP
          username: ${{ secrets.PROD_SERVER_USER }}    # Add to GitHub Secrets: Production SSH user
          key: ${{ secrets.PROD_SERVER_SSH_KEY }}      # Add to GitHub Secrets: Production SSH private key
          port: ${{ secrets.PROD_SERVER_PORT || 22 }}  # Add to GitHub Secrets: Production SSH port
          script: |
            # Create directory if it doesn't exist
            mkdir -p /var/www/Navazino/production/dist
            
            # Create timestamped backup
            if [ -d "/var/www/Navazino/production/dist" ] && [ "$(ls -A /var/www/Navazino/production/dist)" ]; then
              TIMESTAMP=$(date +%Y%m%d_%H%M%S)
              cp -r /var/www/Navazino/production/dist /var/www/Navazino/production/dist.backup.$TIMESTAMP
              echo "âœ… Backup created: dist.backup.$TIMESTAMP"
              
              # Keep only last 5 backups
              cd /var/www/Navazino/production
              ls -td dist.backup.* | tail -n +6 | xargs rm -rf
              echo "Old backups cleaned (kept last 5)"
            fi
            
            # Clean current directory
            rm -rf /var/www/Navazino/production/dist/*
            echo "Production directory ready"

      # ============================================================
      # DEPLOYMENT: Upload to production
      # ============================================================
      - name: Deploy to Production Server
        run: |
          # Setup SSH
          mkdir -p ~/.ssh
          echo "${{ secrets.PROD_SERVER_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.PROD_SERVER_HOST }} >> ~/.ssh/known_hosts
          
          # Deploy via rsync
          rsync -avz --delete \
            dist/ \
            ${{ secrets.PROD_SERVER_USER }}@${{ secrets.PROD_SERVER_HOST }}:/var/www/Navazino/production/dist/
          
          echo "Production files uploaded!"

      # ============================================================
      # HEALTH CHECK: Verify production is working
      # If fails â†’ Automatic rollback!
      # ============================================================
      - name: Health Check - Production
        id: health_check
        run: |
          echo "Waiting for production server to respond..."
          sleep 10
          
          for i in {1..30}; do
            STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://navazino.com || echo "000")
            if [ "$STATUS" -eq 200 ] || [ "$STATUS" -eq 304 ]; then
              echo "âœ… Production deployment successful! (HTTP $STATUS)"
              exit 0
            fi
            echo "Attempt $i/30: HTTP $STATUS, retrying in 5 seconds..."
            sleep 5
          done
          
          echo "âŒ Health check failed, triggering rollback!"
          exit 1

      # ============================================================
      # FAILSAFE: Automatic rollback if health check fails
      # ============================================================
      - name: Rollback Production on Failure
        if: failure()
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.PROD_SERVER_HOST }}
          username: ${{ secrets.PROD_SERVER_USER }}
          key: ${{ secrets.PROD_SERVER_SSH_KEY }}
          port: ${{ secrets.PROD_SERVER_PORT || 22 }}
          script: |
            cd /var/www/Navazino/production
            
            # Find latest backup
            LATEST_BACKUP=$(ls -td dist.backup.* 2>/dev/null | head -1)
            
            if [ -n "$LATEST_BACKUP" ]; then
              echo "ğŸ”„ Rolling back to: $LATEST_BACKUP"
              rm -rf dist/*
              cp -r $LATEST_BACKUP/* dist/
              echo "âœ… Rollback complete! Production restored."
            else
              echo "âŒ No backup found! Production may be broken!"
              exit 1
            fi

      - name: Send Telegram - Production deployed successfully
        if: success() && env.TELEGRAM_BOT_TOKEN != ''
        run: |
          curl -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -H 'Content-Type: application/json' \
            -d "{
              \"chat_id\": \"${TELEGRAM_CHAT_ID}\",
              \"message_thread_id\": ${TELEGRAM_TOPIC_ID:-null},
              \"text\": \"ğŸ‰ **PRODUCTION Deployment SUCCESSFUL**\n\nâœ… Live version updated!\nğŸŒ URL: https://navazino.com\nâœ“ Health check passed\n\nğŸ“ Commit: ${{ github.event.head_commit.message }}\nğŸ‘¤ Deployed by: ${{ github.actor }}\n\nğŸš€ App is now LIVE for users!\",
              \"parse_mode\": \"Markdown\"
            }"

      - name: Send Telegram - Production deployment failed
        if: failure() && env.TELEGRAM_BOT_TOKEN != ''
        run: |
          curl -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -H 'Content-Type: application/json' \
            -d "{
              \"chat_id\": \"${TELEGRAM_CHAT_ID}\",
              \"message_thread_id\": ${TELEGRAM_TOPIC_ID:-null},
              \"text\": \"ğŸš¨ **PRODUCTION Deployment FAILED & ROLLED BACK**\n\nâŒ Automatic rollback initiated\nâœ… Previous version restored\nâš ï¸ Users are safe (old version running)\n\nğŸ‘¤ Attempted by: ${{ github.actor }}\nğŸ“ Commit: ${{ github.event.head_commit.message }}\n\nğŸ”— [View Logs](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})\n\nğŸ‘¥ @DevOps Please investigate immediately!\",
              \"parse_mode\": \"Markdown\"
            }"
